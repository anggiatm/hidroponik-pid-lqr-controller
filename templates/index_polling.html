<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Full Hydroponic Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <style>
      /* Agar pas satu layar tanpa scroll */
      html,
      body {
        height: 100%;
        background-color: #f0f2f5;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        overflow-x: hidden; /* Mencegah scroll horizontal */
      }

      .dashboard-container {
        height: calc(100vh - 56px); /* Tinggi layar dikurangi tinggi navbar */
        padding: 15px;
      }

      .card {
        border: none;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        margin-bottom: 15px;
      }

      .card-header {
        background-color: #fff;
        border-bottom: 1px solid #f0f0f0;
        font-weight: 600;
        padding: 10px 15px;
      }

      .value-display {
        font-size: 2rem;
        font-weight: bold;
        color: #2c3e50;
        line-height: 1.2;
      }

      .target-display {
        color: #7f8c8d;
        font-size: 0.85rem;
      }

      /* Motor Indicator Compact Style */
      .motor-status-compact {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px;
        border-radius: 6px;
        background-color: #f8f9fa;
        margin-bottom: 5px;
      }

      .motor-icon {
        font-size: 1.2rem;
        color: #bdc3c7;
        margin-right: 10px;
        transition: color 0.3s ease;
      }

      .motor-on {
        color: #2ecc71;
      }

      /* PID Tuning Compact */
      .tuning-input {
        font-size: 0.9rem;
        padding: 0.25rem 0.5rem;
      }
      .input-group-text-sm {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
      }

      .pid-value-monitor {
        font-family: "Courier New", monospace;
        font-weight: bold;
        font-size: 0.9rem;
      }

      /* Graph Container Height */
      .graph-container {
        height: 40vh; /* Menggunakan persentase tinggi layar */
        min-height: 250px;
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-1">
      <div class="container-fluid">
        <a class="navbar-brand font-monospace" href="#"
          ><i class="fas fa-leaf me-2"></i>HydroMonitor Pro</a
        >
      </div>
    </nav>

    <div class="container-fluid dashboard-container">
      <div class="row h-100">
        <div class="col-lg-2 d-flex flex-column">
          <div class="card mb-3">
            <div class="card-header py-2">
              <i class="fas fa-sliders-h me-2"></i>Targets & Actuators
            </div>
            <div class="card-body p-3">
              <form
                action="/set_target"
                method="post"
                class="row g-2 align-items-end mb-3"
              >
                <div class="col-6">
                  <label class="form-label small mb-1">TDS Target</label>
                  <input
                    type="number"
                    class="form-control form-control-sm"
                    name="target_ppm"
                    value="{{ target_ppm }}"
                    required
                  />
                </div>
                <div class="col-6">
                  <label class="form-label small mb-1">pH Target</label>
                  <input
                    type="number"
                    step="0.1"
                    class="form-control form-control-sm"
                    name="target_ph"
                    value="{{ target_ph }}"
                    required
                  />
                </div>
                <div class="col-12 mt-2">
                  <button type="submit" class="btn btn-primary btn-sm w-100">
                    Set
                  </button>
                </div>
              </form>
              <hr class="my-2" />
              <h6 class="small text-muted mb-2">Actuators Status</h6>
              <div class="motor-status-compact">
                <div>
                  <i class="fas fa-faucet motor-icon" id="icon_motor_air"></i>
                  <small>Water (PPM↓)</small>
                </div>
                <span class="badge bg-secondary" id="badge_motor_air">OFF</span>
              </div>
              <div class="motor-status-compact">
                <div>
                  <i
                    class="fas fa-fill-drip motor-icon"
                    id="icon_motor_nutrisi"
                  ></i>
                  <small>Nutrient (PPM↑)</small>
                </div>
                <span class="badge bg-secondary" id="badge_motor_nutrisi"
                  >OFF</span
                >
              </div>
              <div class="motor-status-compact">
                <div>
                  <i
                    class="fas fa-arrow-up motor-icon"
                    id="icon_motor_phup"
                  ></i>
                  <small>pH Up</small>
                </div>
                <span class="badge bg-secondary" id="badge_motor_phup"
                  >OFF</span
                >
              </div>
              <div class="motor-status-compact">
                <div>
                  <i
                    class="fas fa-arrow-down motor-icon"
                    id="icon_motor_phdown"
                  ></i>
                  <small>pH Down</small>
                </div>
                <span class="badge bg-secondary" id="badge_motor_phdown"
                  >OFF</span
                >
              </div>
            </div>
          </div>

          <div class="card flex-grow-1">
            <div
              class="card-header py-2 d-flex justify-content-between align-items-center"
            >
              <span><i class="fas fa-microchip me-2"></i>PID Tuning</span>
              <button
                type="button"
                onclick="submitPID()"
                class="btn btn-success btn-sm px-3"
              >
                Update PID
              </button>
            </div>
            <div class="card-body p-3" style="overflow-y: auto">
              <form id="pidForm">
                <h6 class="text-info small border-bottom pb-1 mb-2">
                  TDS (PPM) Parameters
                </h6>
                <div class="row g-1 mb-2">
                  <div class="col-4">
                    <div class="input-group input-group-sm">
                      <span class="input-group-text input-group-text-sm"
                        >Kp</span
                      >
                      <input
                        type="number"
                        step="0.01"
                        class="form-control tuning-input"
                        name="tds_kp"
                      />
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="input-group input-group-sm">
                      <span class="input-group-text input-group-text-sm"
                        >Ki</span
                      >
                      <input
                        type="number"
                        step="0.001"
                        class="form-control tuning-input"
                        name="tds_ki"
                      />
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="input-group input-group-sm">
                      <span class="input-group-text input-group-text-sm"
                        >Kd</span
                      >
                      <input
                        type="number"
                        step="0.001"
                        class="form-control tuning-input"
                        name="tds_kd"
                      />
                    </div>
                  </div>
                </div>

                <h6 class="text-warning small border-bottom pb-1 mb-2 mt-3">
                  pH Parameters
                </h6>
                <div class="row g-1 mb-2">
                  <div class="col-4">
                    <div class="input-group input-group-sm">
                      <span class="input-group-text input-group-text-sm"
                        >Kp</span
                      >
                      <input
                        type="number"
                        step="0.01"
                        class="form-control tuning-input"
                        name="ph_kp"
                      />
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="input-group input-group-sm">
                      <span class="input-group-text input-group-text-sm"
                        >Ki</span
                      >
                      <input
                        type="number"
                        step="0.001"
                        class="form-control tuning-input"
                        name="ph_ki"
                      />
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="input-group input-group-sm">
                      <span class="input-group-text input-group-text-sm"
                        >Kd</span
                      >
                      <input
                        type="number"
                        step="0.001"
                        class="form-control tuning-input"
                        name="ph_kd"
                      />
                    </div>
                  </div>
                </div>
                <div class="form-check mt-2 small">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="resetIntegral"
                    name="reset_integral"
                    value="true"
                  />
                  <label class="form-check-label text-muted" for="resetIntegral"
                    >Reset Integral Sum</label
                  >
                </div>
                <div
                  id="pidResponse"
                  class="mt-1 small text-success"
                  style="display: none; font-weight: bold"
                >
                  Saved!
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="col-lg-10 d-flex flex-column">
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="card h-100 border-start border-4 border-info">
                <div class="card-body p-3">
                  <div class="d-flex justify-content-between mb-2">
                    <h5 class="text-info m-0">
                      <i class="fas fa-water me-2"></i>TDS (PPM)
                    </h5>
                    <div class="text-end">
                      <small
                        class="text-muted d-block"
                        style="font-size: 0.7rem"
                        >Control Output:</small
                      >
                      <span id="control_ppm" class="fw-bold">0.00s</span>
                    </div>
                  </div>
                  <div class="d-flex justify-content-between align-items-end">
                    <div class="value-display" id="real_ppm">0</div>
                    <div class="target-display mb-1">
                      Target:
                      <span id="disp_target_ppm" class="fw-bold"
                        >{{ target_ppm }}</span
                      >
                    </div>
                  </div>
                  <div
                    class="bg-light rounded p-2 mt-3 d-flex justify-content-between small"
                  >
                    <span
                      >P:
                      <span id="tds_P" class="pid-value-monitor text-primary"
                        >0</span
                      ></span
                    >
                    <span
                      >I:
                      <span id="tds_I" class="pid-value-monitor text-warning"
                        >0</span
                      ></span
                    >
                    <span
                      >D:
                      <span id="tds_D" class="pid-value-monitor text-danger"
                        >0</span
                      ></span
                    >
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card h-100 border-start border-4 border-warning">
                <div class="card-body p-3">
                  <div class="d-flex justify-content-between mb-2">
                    <h5 class="text-warning m-0">
                      <i class="fas fa-flask me-2"></i>pH Level
                    </h5>
                    <div class="text-end">
                      <small
                        class="text-muted d-block"
                        style="font-size: 0.7rem"
                        >Control Output:</small
                      >
                      <span id="control_ph" class="fw-bold">0.00s</span>
                    </div>
                  </div>
                  <div class="d-flex justify-content-between align-items-end">
                    <div class="value-display" id="real_ph">0.0</div>
                    <div class="target-display mb-1">
                      Target:
                      <span id="disp_target_ph" class="fw-bold"
                        >{{ target_ph }}</span
                      >
                    </div>
                  </div>
                  <div
                    class="bg-light rounded p-2 mt-3 d-flex justify-content-between small"
                  >
                    <span
                      >P:
                      <span id="ph_P" class="pid-value-monitor text-primary"
                        >0</span
                      ></span
                    >
                    <span
                      >I:
                      <span id="ph_I" class="pid-value-monitor text-warning"
                        >0</span
                      ></span
                    >
                    <span
                      >D:
                      <span id="ph_D" class="pid-value-monitor text-danger"
                        >0</span
                      ></span
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row flex-grow-1">
            <div class="col-md-6 d-flex flex-column">
              <div class="card flex-grow-1 mb-0">
                <div class="card-header py-1 small">TDS History</div>
                <div class="card-body p-1">
                  <div id="ppm-graph" class="graph-container w-100"></div>
                </div>
              </div>
            </div>
            <div class="col-md-6 d-flex flex-column">
              <div class="card flex-grow-1 mb-0">
                <div class="card-header py-1 small">pH History</div>
                <div class="card-body p-1">
                  <div id="ph-graph" class="graph-container w-100"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // --- FUNGSI UPDATE DATA SENSOR & STATUS (Sama seperti sebelumnya) ---
      function updateValues() {
        fetch("/update_values")
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("real_ppm").innerText = data.real_ppm;
            document.getElementById("real_ph").innerText = data.real_ph;
            document.getElementById("disp_target_ppm").innerText =
              data.target_ppm;
            document.getElementById("disp_target_ph").innerText =
              data.target_ph;
            document.getElementById("control_ppm").innerText =
              data.control_ppm + "s";
            document.getElementById("control_ph").innerText =
              data.control_ph + "s";
            document.getElementById("tds_P").innerText = data.tds_P;
            document.getElementById("tds_I").innerText = data.tds_I;
            document.getElementById("tds_D").innerText = data.tds_D;
            document.getElementById("ph_P").innerText = data.ph_P;
            document.getElementById("ph_I").innerText = data.ph_I;
            document.getElementById("ph_D").innerText = data.ph_D;

            updateMotorVisual("motor_air", data.motor_air);
            updateMotorVisual("motor_nutrisi", data.motor_nutrisi);
            updateMotorVisual("motor_phup", data.motor_phup);
            updateMotorVisual("motor_phdown", data.motor_phdown);
          })
          .catch((error) => console.error("Error:", error));
      }

      function updateMotorVisual(motorId, status) {
        const icon = document.getElementById(`icon_${motorId}`);
        const badge = document.getElementById(`badge_${motorId}`);
        // Logic: status 0 means ON (Active Low relay), 1 means OFF
        const isRunning = status === 0;

        if (isRunning) {
          icon.classList.add("motor-on");
          badge.className = "badge bg-success";
          badge.innerText = "ON";
        } else {
          icon.classList.remove("motor-on");
          badge.className = "badge bg-secondary";
          badge.innerText = "OFF";
        }
      }

      // --- FUNGSI UPDATE GRAFIK (Layout disesuaikan agar compact) ---
      function updateGraph() {
        fetch("/update_graph")
          .then((response) => response.json())
          .then((data) => {
            // Layout yang sangat compact untuk grafik
            const layout = {
              margin: { t: 10, b: 30, l: 40, r: 10 }, // Margin tipis
              showlegend: false, // Hilangkan legend agar hemat tempat
              xaxis: {
                showgrid: false,
                zeroline: false,
                showticklabels: false,
              }, // Sembunyikan label X axis
              yaxis: { showgrid: true, gridcolor: "#f0f0f0" },
              paper_bgcolor: "rgba(0,0,0,0)",
              plot_bgcolor: "rgba(0,0,0,0)",
              autosize: true,
            };

            // Graph PPM
            const ppmPlotData = [
              {
                y: data.ppm_values,
                type: "line",
                name: "Real",
                line: { color: "#0dcaf0", width: 2 },
                fill: "tozeroy",
                fillcolor: "rgba(13, 202, 240, 0.1)",
              },
              {
                y: Array(data.ppm_values.length).fill(data.target_ppm),
                type: "line",
                name: "Target",
                line: { dash: "dot", color: "gray", width: 1 },
              },
            ];
            Plotly.react("ppm-graph", ppmPlotData, layout, {
              displayModeBar: false,
            }); // displayModeBar: false menghilangkan toolbar plotly

            // Graph pH
            const phPlotData = [
              {
                y: data.ph_values,
                type: "line",
                name: "Real",
                line: { color: "#ffc107", width: 2 },
                fill: "tozeroy",
                fillcolor: "rgba(255, 193, 7, 0.1)",
              },
              {
                y: Array(data.ph_values.length).fill(data.target_ph),
                type: "line",
                name: "Target",
                line: { dash: "dot", color: "gray", width: 1 },
              },
            ];
            Plotly.react("ph-graph", phPlotData, layout, {
              displayModeBar: false,
            });
          });
      }

      // --- FUNGSI SUBMIT PID TUNING ---
      function submitPID() {
        const form = document.getElementById("pidForm");
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        fetch("/set_pid", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        })
          .then((response) => response.json())
          .then((result) => {
            const msg = document.getElementById("pidResponse");
            msg.style.display = "block";
            msg.innerText = result.message || "Saved!";
            setTimeout(() => {
              msg.style.display = "none";
            }, 2000);
            form.reset(); // Optional: reset form setelah submit
          })
          .catch((error) => alert("Error updating PID"));
      }

      // Jalankan interval
      setInterval(updateValues, 500);
      setInterval(updateGraph, 2000);
      // Resize grafik saat jendela browser diubah ukurannya
      window.onresize = function () {
        Plotly.Plots.resize("ppm-graph");
        Plotly.Plots.resize("ph-graph");
      };
    </script>
  </body>
</html>
